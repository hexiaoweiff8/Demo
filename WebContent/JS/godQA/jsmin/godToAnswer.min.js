$(function(){function a(){var a=parseInt($(".god-to-answer").css("padding-top")),c=$(window).height(),d=j.height(),e=l.height(),f=Math.ceil(2*a+e+d);p=c-f,b()}function b(){var a=h.val().trim().length;i.text(h.val());var b=i.height();h.height(p>b?b:p),k.text(a),a>2e3?k.addClass("warning"):k.removeClass("warning")}var c=$.parseGet("source"),d=c?c:"jrm",e="",f=$.parseGet("sid"),g={urlBridgev2:"http://minner.jr.jd.com/godQA/jsmin/bridgev2.min.js",urlUploadFile:"http://msinner.jr.jd.com/jj/h5/uploadFile.action",urlSaveReply:"http://msinner.jr.jd.com/jj/h5/comment/saveReply.action?source="+d,urlLogin:"http://passport.m.jd.com/user/login.action?source="+d,urlGodTopic:"http://minner.jr.jd.com/godQA/godTopic.html?source="+d,urlToAnswer:"http://minner.jr.jd.com/godQA/godToAnswer.html?source="+d};"app"===d&&(e="loading",$.asyncLoadScript(g.urlBridgev2,function(){e="loaded",window.oBridgeV2||(window.oBridgeV2=jsBridgeV2&&new jsBridgeV2(function(a){"string"==typeof a&&(a=JSON.parse(a)),"data"in a&&(window.location.href=window.appUrlLoginBack+"&sid="+$.base64encode(decodeURIComponent(a.data)))})),window.oBridgeV2&&window.oBridgeV2.jsToNaWeiXin({isShow:!1,optionType:1,btnText:"",shareDate:{appId:"",img:"",link:"",desc:"",title:"",friendesc:"",type:""}})}));var h=$("#god_to_answer"),i=$(".t-measure div"),j=$(".to-answer-assets"),k=j.find(".word-count"),l=$("#god_to_sub"),m="placeholder"in document.createElement("input");if(!m){var n=h.attr("placeholder"),o=h.val();h.bind("focus",function(){h.val()===n&&h.val("")}),h.bind("blur",function(){""===h.val()&&h.val(n)}),o||h.val(n)}var p=0;a(),$(window).resize(a),h.bind("input",b);var q=$("#god_to_upload"),r=q.siblings("img"),s=q.siblings(".close"),t=!1;q.bind("change",function(){if(this.files.length>0){var a=this.files[0],b=a.type,c=/image\/(png|jpg|jpeg|gif|bmp|tiff)/i,d=c.test(b),e=a.size/1048576,f=4>e;t=!1,h.val(b+"&"+e),d?f?(r.attr("src",window.URL.createObjectURL(a)),s.show(),t=!0):(q[0].files=[],q[0].value="",s.trigger("tap"),$.emitNotification("抱歉，所传图片大小不能超过4M")):(q[0].files=[],q[0].value="",s.trigger("tap"),$.emitNotification("抱歉，仅支持png,gif,jpg,jpeg,bmp,tiff格式的图片"))}}),s.bind("tap",function(){r.attr("src","./img/defaultUpload.png"),t=!1,q[0].files=[],q[0].value="",s.hide()}),l.tap(function(){function a(a){var a=a||"";$.ajax({type:"GET",url:g.urlSaveReply,dataType:"jsonp",data:{sid:f,topicId:c,content:i,pictureUrl:a},success:function(a){"string"==typeof a&&(a=JSON.parse(a)),3===a.resultCode?(window.appUrlLoginBack=g.urlToAnswer+"&tid="+c,$.gonnaLogin(d,{accessViaWeb:g.urlLogin,urlBridgev2:g.urlBridgev2},function(){return e})):a.resultData&&a.resultData.result?$.emitNotification("发布成功",function(){window.location.href=g.urlGodTopic+"&sid="+f+"&tid="+c}):($.emitNotification(a.resultData&&a.resultData.msg||"发布失败，请检查网络后，重新尝试"),b.removeClass("lock"),b.text("发布"))}})}var b=$(this);if(!b.hasClass("lock")){var c=$.parseGet("tid"),i=h.val().trim();if(""==i)$.emitNotification("抱歉，回答不能为空"),h.focus();else if(k.hasClass("warning"))$.emitNotification("回答内容不能超过2000字"),h.focus();else if(b.addClass("lock").initDottedLoading("发布中"),t){var j=new FormData;j.append("file",q[0].files[0]),j.append("sid",f),j.append("source",d);var l="jsonpPost"+(new Date).getTime().toString(16);j.append("callback",l),$.ajax({type:"POST",url:g.urlUploadFile,data:j,processData:!1,contentType:!1,success:function(f){if("string"==typeof f){var h=new RegExp("^"+l);f=f.replace(h,"").replace(/(^\s*\()|(\)\s*$)/gm,""),f=JSON.parse(f)}3===f.resultCode?(window.appUrlLoginBack=g.urlToAnswer+"&tid="+c,$.gonnaLogin(d,{accessViaWeb:g.urlLogin,urlBridgev2:g.urlBridgev2},function(){return e})):f.resultData&&"0"===f.resultData.code?a(f.resultData.imageUrl):($.emitNotification(f.resultData&&f.resultData.msg||"上传图片失败，请检查网络后，重新尝试"),b.removeClass("lock"),b.text("发布"))}})}else a()}})});